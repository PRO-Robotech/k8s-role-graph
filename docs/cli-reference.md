# Справочник CLI

## rbacgraph-apiserver

Агрегированный API-сервер, обрабатывающий запросы `RoleGraphReview`. Построен на фреймворке Kubernetes `GenericAPIServer`.

### Основные флаги

| Флаг | По умолчанию | Описание |
|---|---|---|
| `--secure-port` | `443` | HTTPS-порт для прослушивания. Установите `0` для отключения. |
| `--bind-address` | `0.0.0.0` | IP-адрес для привязки secure-порта. |
| `--tls-cert-file` | — | Путь к файлу TLS-сертификата (x509). |
| `--tls-private-key-file` | — | Путь к файлу приватного TLS-ключа. |
| `--kubeconfig` | — | Путь к kubeconfig для подключения к кластеру. Пусто означает in-cluster конфигурацию. |
| `--resync-period` | `0` | Период ресинка информеров (например, `30s`, `5m`). `0` означает без периодического ресинка — обновления только по watch-событиям. |

### Флаги аутентификации и авторизации

Эти флаги регистрируются Kubernetes `RecommendedOptions` и управляют тем, как API-сервер аутентифицирует и авторизует запросы (через делегирование к kube-apiserver).

| Флаг | По умолчанию | Описание |
|---|---|---|
| `--authentication-kubeconfig` | — | Kubeconfig для делегирования аутентификации. |
| `--authentication-token-webhook-cache-ttl` | `10s` | TTL кэша результатов аутентификации. |
| `--authorization-kubeconfig` | — | Kubeconfig для делегирования авторизации. |
| `--authorization-webhook-cache-authorized-ttl` | `10s` | TTL кэша авторизованных результатов. |
| `--authorization-webhook-cache-unauthorized-ttl` | `10s` | TTL кэша неавторизованных результатов. |

### Флаги аудита

| Флаг | По умолчанию | Описание |
|---|---|---|
| `--audit-log-path` | — | Путь к файлу лога аудита. `-` для stdout. |
| `--audit-log-maxage` | `0` | Максимальное число дней хранения старых файлов лога аудита. |
| `--audit-log-maxbackup` | `0` | Максимальное число файлов лога аудита для хранения. |
| `--audit-log-maxsize` | `0` | Максимальный размер в МБ, после которого файл лога аудита ротируется. |
| `--audit-policy-file` | — | Путь к файлу политики аудита. |

> **Примечание:** Флаги Etcd и Admission **не** регистрируются — у этого сервера нет персистентного хранилища и admission-контроллеров.

### Эндпоинты

| Путь | Метод | Описание |
|---|---|---|
| `/apis/rbacgraph.incloud.io/v1alpha1/rolegraphreviews` | POST | Выполнить запрос к RBAC-графу. |
| `/apis/rbacgraph.incloud.io/v1alpha1` | GET | Обнаружение API-группы. |
| `/readyz` | GET | Проба готовности (кэши информеров синхронизированы). |
| `/livez` | GET | Проба живости. |
| `/openapi/v2` | GET | Спецификация OpenAPI v2. |
| `/openapi/v3` | GET | Спецификация OpenAPI v3. |

---

## rbacgraph-web

Веб-фронтенд-прокси. Отдаёт React UI и проксирует API-запросы `/api/query` к агрегированному API-серверу через kube-apiserver кластера.

### Флаги

| Флаг | По умолчанию | Описание |
|---|---|---|
| `--listen` | `:8080` | Адрес HTTP-прослушивания (например, `:8080`, `127.0.0.1:3000`). |
| `--kubeconfig` | — | Путь к kubeconfig. Пусто означает in-cluster конфигурацию. |

### Эндпоинты

| Путь | Метод | Описание |
|---|---|---|
| `/` | GET | Веб-интерфейс (`index.html`). |
| `/static/*` | GET | Статические ресурсы (JS, CSS, изображения). Кэшируются на 1 час. |
| `/api/query` | POST | Прокси к агрегированному API-серверу. Принимает все три [формата запросов](query-guide.md#форматы-запросов). |
| `/api/health` | GET | Проверка здоровья. Возвращает `{"status":"ok"}`. |

### Пример: локальная разработка

```bash
# Запуск веб-сервера локально с указанием на удалённый кластер
rbacgraph-web --listen :3000 --kubeconfig ~/.kube/config
```

### Пример: port-forward (production)

```bash
# Доступ к in-cluster веб-серверу с вашей машины
kubectl port-forward -n rbac-graph-system svc/rbacgraph-web 8080:80
```
